<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>标准研制 - 国家市场监督管理总局技术创新中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tech-blue': '#004098',   
                        'tech-dark': '#003380',
                        'text-main': '#333333',
                    },
                    fontFamily: { 'sans': ['Microsoft YaHei', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: "Microsoft YaHei", sans-serif; }
        /* 头部背景 */
        .header-tech-bg {
            background-color: #001540;
            background-image: radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.15) 0%, transparent 50%), linear-gradient(to right, #001540, #003380, #001540);
            position: relative;
        }
        .header-tech-bg::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px; pointer-events: none;
        }
        /* 导航特效 */
        .nav-item { position: relative; }
        .nav-item::after {
            content: ''; position: absolute; bottom: 8px; left: 50%; width: 0%; height: 2px;
            background-color: #fff; transform: translateX(-50%); transition: width 0.3s ease;
        }
        .nav-item:hover::after { width: 60%; }
        /* 状态标签样式 */
        .status-active { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; } /* 现行 */
        .status-draft { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; } /* 征求意见 */
        .status-upcoming { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; } /* 即将实施 */
    </style>
</head>
<body class="bg-gray-50 text-[#333] flex flex-col min-h-screen">

    <!-- ================= 1. 顶部 Header ================= -->
    <div class="w-full text-white pb-0 header-tech-bg">
        <header class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-7 relative z-10">
            <div class="flex flex-col lg:flex-row justify-between items-center gap-6">
                <div class="flex items-center gap-5 self-start lg:self-center">
                    <div class="w-16 h-16 shrink-0 flex items-center justify-center">
                        <img src="figure/nevsc_logo.png" alt="Logo" class="w-full h-full object-contain drop-shadow-md" onerror="this.parentElement.innerHTML='LOG'">
                    </div>
                    <div class="flex flex-col justify-center gap-1">
                        <h1 class="text-sm md:text-lg text-blue-100 font-bold tracking-wide opacity-90 text-justify">国家市场监督管理总局技术创新中心</h1>
                        <h2 class="text-sm md:text-lg text-blue-100 font-medium tracking-wide opacity-90 text-justify">(新能源汽车数字监管技术及应用)</h2>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2 w-full lg:w-auto mt-4 lg:mt-0">
                    <div class="relative w-full md:w-64 group">
                        <input type="text" id="global-search-input" placeholder="输入关键词..." autocomplete="off"
                            class="w-full bg-white/10 border border-white/20 text-white text-sm rounded-full pl-4 pr-10 py-1.5 
                                    focus:outline-none focus:bg-white/15 focus:border-blue-300 transition shadow-inner backdrop-blur-sm">
                        <button id="global-search-btn" class="absolute right-3 top-1/2 -translate-y-1/2 text-white/70 hover:text-white transition">
                            <i class="fa-solid fa-magnifying-glass text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>
        <nav class="border-t border-white/10 mt-2 relative z-10" style="background-color: rgba(255, 255, 255, 0.05);"> 
            <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-wrap justify-center space-x-2">
                    <a href="index.html" class="nav-item text-blue-100 hover:text-white px-8 py-4 text-base tracking-widest transition relative">首页</a>
                    <a href="about.html" class="nav-item text-blue-100 hover:text-white px-6 py-4 font-medium transition text-base tracking-wide">中心概况</a>
                    <a href="news.html" class="nav-item text-blue-100 hover:text-white px-6 py-4 font-medium transition text-base tracking-wide">新闻动态</a>
                    <a href="activity.html" class="nav-item text-blue-100 hover:text-white px-6 py-4 font-medium transition text-base tracking-wide">行业活动</a>
                    <a href="standards.html" class="text-white font-bold px-6 py-4 font-medium transition text-base tracking-wide relative after:content-[''] after:absolute after:bottom-0 after:left-0 after:w-full after:h-1 after:bg-white">标准研制</a>
                    <a href="research.html" class="nav-item text-blue-100 hover:text-white px-6 py-4 font-medium transition text-base tracking-wide">技术研究</a>
                </div>
            </div>
        </nav>
    </div>

    <!-- 面包屑 -->
    <div class="bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="text-sm text-gray-500 flex items-center">
                <a href="index.html" class="hover:text-[#004098] transition"><i class="fa-solid fa-house mr-1"></i> 首页</a>
                <span class="mx-2 text-gray-300">/</span>
                <span class="text-gray-800 font-medium">标准研制</span>
            </div>
        </div>
    </div>

    <!-- ================= 3. 内容主体 ================= -->
    <main class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-10 flex-grow w-full">
        
        <!-- 搜索与筛选区 -->
        <div class="bg-white p-6 rounded shadow-sm border border-gray-100 mb-8">
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <!-- 搜索框 -->
                <div class="relative flex-1 w-full">
                    <input type="text" id="searchInput" placeholder="输入标准号或标准名称..." 
                           class="w-full border border-gray-300 rounded px-4 py-2.5 focus:outline-none focus:border-[#004098] transition">
                    <button id="searchBtn" class="absolute right-0 top-0 h-full bg-[#004098] text-white px-6 rounded-r hover:bg-[#003380] transition">
                        <i class="fa-solid fa-search"></i> 检索
                    </button>
                </div>
            </div>
            
            <!-- 分类 Tabs -->
            <div class="flex gap-2 mt-6 border-b border-gray-200 overflow-x-auto">
                <button data-type="all" class="std-tab px-6 py-2 text-sm font-bold text-[#004098] border-b-2 border-[#004098] hover:bg-gray-50 transition whitespace-nowrap">全部</button>
                <button data-type="GB" class="std-tab px-6 py-2 text-sm text-gray-600 border-b-2 border-transparent hover:text-[#004098] hover:bg-gray-50 transition whitespace-nowrap">国家标准</button>
                <button data-type="QC" class="std-tab px-6 py-2 text-sm text-gray-600 border-b-2 border-transparent hover:text-[#004098] hover:bg-gray-50 transition whitespace-nowrap">行业标准</button>
                <button data-type="DB" class="std-tab px-6 py-2 text-sm text-gray-600 border-b-2 border-transparent hover:text-[#004098] hover:bg-gray-50 transition whitespace-nowrap">地方标准</button>
                <button data-type="T" class="std-tab px-6 py-2 text-sm text-gray-600 border-b-2 border-transparent hover:text-[#004098] hover:bg-gray-50 transition whitespace-nowrap">团体标准</button>
            </div>
        </div>

        <!-- 标准列表 -->
        <div class="bg-white rounded shadow-sm border border-gray-100 overflow-hidden min-h-[400px]">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 text-gray-500 text-sm border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-4 font-medium w-1/5 whitespace-nowrap">标准编号</th>
                        <th class="px-6 py-4 font-medium w-2/5">标准名称</th>
                        <th class="px-6 py-4 font-medium w-1/6 whitespace-nowrap">状态</th>
                        <th class="px-6 py-4 font-medium w-1/6 whitespace-nowrap">发布日期</th>
                        <!-- 修改：添加 whitespace-nowrap 强制不换行，并设定最小宽度 -->
                        <th class="px-6 py-4 font-medium text-right whitespace-nowrap w-24">操作</th>
                    </tr>
                </thead>
                <tbody id="standards-table-body" class="text-sm text-[#333]">
                    <!-- JS 渲染内容 -->
                    <tr>
                        <td colspan="5" class="text-center py-10 text-gray-400">
                            <i class="fa-solid fa-spinner fa-spin mr-2"></i> 正在加载数据...
                        </td>
                    </tr>
                </tbody>
            </table>
            <!-- 分页 -->
            <div class="flex justify-between items-center p-6 border-t border-gray-100">
                <span class="text-sm text-gray-500">共 <span id="total-count">0</span> 条记录</span>
                <div class="flex gap-2">
                    <button id="prevPage" class="px-3 py-1 border rounded text-gray-400 cursor-not-allowed" disabled>上一页</button>
                    <button id="page1" class="px-3 py-1 bg-[#004098] text-white rounded">1</button>
                    <button id="nextPage" class="px-3 py-1 border rounded hover:bg-gray-50 cursor-not-allowed" disabled>下一页</button>
                </div>
            </div>
        </div>

    </main>

    <!-- ================= 4. 页脚 ================= -->
    <footer class="bg-[#1e293b] text-gray-400 pt-12 pb-8 mt-auto border-t-4 border-[#004098]">
        <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-10 mb-10">
                <div class="col-span-1 md:col-span-2">
                    <h4 class="text-white font-bold text-lg mb-5 border-l-4 border-[#004098] pl-3">相关部门链接</h4>
                    <div class="grid grid-cols-2 gap-y-4 gap-x-6 text-sm">
                        <a href="https://www.samr.gov.cn/" target="_blank" class="hover:text-white hover:underline flex items-center transition"><i class="fa-solid fa-link mr-2 text-gray-600"></i>国家市场监督管理总局</a>
                        <a href="https://www.samrdprc.org.cn/" target="_blank" class="hover:text-white hover:underline flex items-center transition"><i class="fa-solid fa-link mr-2 text-gray-600"></i>总局召回中心</a>
                        <a href="https://www.ccic.com/" target="_blank" class="hover:text-white hover:underline flex items-center transition"><i class="fa-solid fa-link mr-2 text-gray-600"></i>中国中检 (CCIC)</a>
                        <a href="https://www.caeri.com.cn/" target="_blank" class="hover:text-white hover:underline flex items-center transition"><i class="fa-solid fa-link mr-2 text-gray-600"></i>中检汽研</a>
                    </div>
                </div>
                <div class="col-span-1 md:col-span-1">
                    <h4 class="text-white font-bold text-lg mb-5 border-l-4 border-[#004098] pl-3">联系我们</h4>
                    <ul class="space-y-3 text-sm">
                        <li class="flex items-start"><i class="fa-solid fa-location-dot mt-1 mr-1 text-gray-500"></i> 地址：北京市朝阳区西坝河东里18号中检大厦</li>
                        <li class="flex items-center"><i class="fa-solid fa-envelope mr-3 text-gray-500"></i> 邮箱：nevsc@caeri.com.cn</li>
                        <li class="flex items-center"><i class="fa-solid fa-phone mr-3 text-gray-500"></i> 电话：010-88888888</li>
                    </ul>
                </div>
                <div class="col-span-1 md:col-span-1 flex flex-col items-center md:items-start">
                    <h4 class="text-white font-bold text-lg mb-5">关注我们</h4>
                    <div class="flex items-center gap-4">
                        <div class="bg-white p-1.5 rounded-lg shadow-lg"><img src="figure/QRcode.jpg" alt="微信公众号" class="w-20 h-20"></div>
                        <div class="text-xs text-gray-400"><p class="mb-1 text-white font-bold">官方微信</p><p>扫一扫了解更多</p><p>行业动态</p></div>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 pt-8 text-center text-xs text-gray-500 font-medium">
                <p>&copy; 2025 国家市场监督管理总局技术创新中心（新能源汽车数字监管技术及应用） 版权所有</p>
            </div>
        </div>
    </footer>

    <!-- 数据脚本 -->
    <script type="module">
        import { supabase } from './js/api.js';
        
        let currentType = 'all';
        let currentKeyword = '';
        let currentPage = 1;
        const pageSize = 10;
        let totalCount = 0;
        
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await loadStandards();
                setupEventListeners();
            } catch (error) {
                console.error('初始化失败:', error);
                showError('页面初始化失败，请刷新重试');
            }
        });
        
        function setupEventListeners() {
            // 搜索按钮事件
            document.getElementById('searchBtn').addEventListener('click', () => {
                currentKeyword = document.getElementById('searchInput').value.trim();
                currentPage = 1;
                loadAndFilterStandards();
            });
            
            // 搜索框回车事件
            document.getElementById('searchInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    currentKeyword = e.target.value.trim();
                    currentPage = 1;
                    loadAndFilterStandards();
                }
            });
            
            // 分页按钮事件
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadAndFilterStandards();
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', () => {
                if (currentPage < Math.ceil(totalCount / pageSize)) {
                    currentPage++;
                    loadAndFilterStandards();
                }
            });
        }
        
        async function loadStandards() {
            await loadAndFilterStandards();
        }
        
        async function loadAndFilterStandards() {
            try {
                showLoading();
                
                // 构建查询
                let query = supabase
                    .from('standards')
                    .select('*', { count: 'exact' });
                
                // 类型过滤
                if (currentType !== 'all') {
                    query = query.eq('type', currentType);
                }
                
                // 关键词搜索
                if (currentKeyword) {
                    query = query.or(`code.ilike.%${currentKeyword}%,title.ilike.%${currentKeyword}%`);
                }
                
                // 排序和分页
                const from = (currentPage - 1) * pageSize;
                query = query
                    .order('created_at', { ascending: false })
                    .range(from, from + pageSize - 1);
                
                const { data, error, count } = await query;
                
                if (error) throw error;
                
                renderTable(data || []);
                updatePagination(count || 0);
                
            } catch (error) {
                console.error('加载标准失败:', error);
                showError('数据加载失败，请检查网络连接');
            }
        }
        
        function renderTable(data) {
            const tbody = document.getElementById('standards-table-body');
            const totalCountElement = document.getElementById('total-count');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-gray-400">暂无相关标准</td></tr>';
                totalCountElement.innerText = '0';
                return;
            }
            
            totalCountElement.innerText = totalCount;
            
            const statusMap = {
                'active': '<span class="status-active px-2 py-0.5 rounded text-xs">现行</span>',
                'draft': '<span class="status-draft px-2 py-0.5 rounded text-xs">征求意见</span>',
                'upcoming': '<span class="status-upcoming px-2 py-0.5 rounded text-xs">即将实施</span>'
            };
            
            let html = '';
            data.forEach(item => {
                // 格式化日期
                const publishDate = item.publish_date || item.created_at;
                const formattedDate = publishDate ? formatDate(publishDate) : '-';
                
                html += `
                    <tr class="hover:bg-blue-50 transition border-b border-gray-100 last:border-0 cursor-pointer" onclick="window.location.href='standard-detail.html?id=${item.id}'">
                        <td class="px-6 py-4 font-mono text-[#004098] font-bold whitespace-nowrap">${item.code || '无编号'}</td>
                        <td class="px-6 py-4 font-medium">${item.title || '无标题'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${statusMap[item.status] || '<span class="px-2 py-0.5 rounded text-xs bg-gray-100 text-gray-600">未知</span>'}</td>
                        <td class="px-6 py-4 text-gray-500 whitespace-nowrap">${formattedDate}</td>
                        <td class="px-6 py-4 text-right whitespace-nowrap">
                            <span class="text-[#004098] hover:underline text-xs">查看详情</span>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }
        
        function updatePagination(count) {
            totalCount = count;
            const totalPages = Math.ceil(count / pageSize);
            
            // 更新分页按钮状态
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            if (currentPage <= 1) {
                prevBtn.disabled = true;
                prevBtn.classList.add('cursor-not-allowed', 'text-gray-400');
            } else {
                prevBtn.disabled = false;
                prevBtn.classList.remove('cursor-not-allowed', 'text-gray-400');
                prevBtn.classList.add('cursor-pointer', 'hover:bg-gray-50');
            }
            
            if (currentPage >= totalPages) {
                nextBtn.disabled = true;
                nextBtn.classList.add('cursor-not-allowed', 'text-gray-400');
            } else {
                nextBtn.disabled = false;
                nextBtn.classList.remove('cursor-not-allowed', 'text-gray-400');
                nextBtn.classList.add('cursor-pointer', 'hover:bg-gray-50');
            }
            
            // 更新页码显示
            const page1Btn = document.getElementById('page1');
            if (totalPages === 0) {
                page1Btn.innerText = '0';
                page1Btn.classList.remove('bg-[#004098]', 'text-white');
                page1Btn.classList.add('bg-gray-100', 'text-gray-400');
            } else {
                page1Btn.innerText = currentPage;
                page1Btn.classList.add('bg-[#004098]', 'text-white');
                page1Btn.classList.remove('bg-gray-100', 'text-gray-400');
            }
        }
        
        function filterStandards(type) {
            // 更新选项卡样式
            document.querySelectorAll('.std-tab').forEach(btn => {
                btn.className = 'std-tab px-6 py-2 text-sm text-gray-600 border-b-2 border-transparent hover:text-[#004098] hover:bg-gray-50 transition whitespace-nowrap';
            });
            event.target.className = 'std-tab px-6 py-2 text-sm font-bold text-[#004098] border-b-2 border-[#004098] hover:bg-gray-50 transition whitespace-nowrap';
            
            // 更新过滤条件
            currentType = type;
            currentPage = 1;
            
            loadAndFilterStandards();
        }
        
        function showLoading() {
            const tbody = document.getElementById('standards-table-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-10 text-gray-400">
                        <i class="fa-solid fa-spinner fa-spin mr-2"></i> 正在加载数据...
                    </td>
                </tr>
            `;
        }
        
        function showError(message) {
            const tbody = document.getElementById('standards-table-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-10 text-red-500">
                        <i class="fa-solid fa-exclamation-triangle mr-2"></i> ${message}
                    </td>
                </tr>
            `;
        }
        
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toISOString().split('T')[0];
            } catch (e) {
                return dateString;
            }
        }
    </script>
    <!-- 引入 API (如果之前没引) 和 Search 逻辑 -->
    <script type="module" src="js/search.js"></script>
</body>
</html>